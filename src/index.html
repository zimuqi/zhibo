<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>基于RTC的直播demo</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<!--头部-->
<nav class="navbar navbar-inverse" role="navigation">
    <div class="container-fluid container">
        <div class="navbar-header">
            <a class="navbar-brand" href="#">基于RTC的直播demo</a>
        </div>
    </div>
</nav>
<!--中间内容-->
<div class="main-body container">
    <div class="video-wrap">
        <video src="" autoplay width="480" height="320" id="video"></video>
    </div>
    <div class="fan-wrap">
        <p>当前房间在线人数：<span class="userNum"></span></p>
        <div class="msg-box">
            <div class="msg-show-area">
                <!--<div class="msg-item clearfix">-->
                    <!--<span class="msg-owner">哈哈哈哈哈啊哈哈哈哈啊哈:</span>-->
                    <!--<p class="msg-content">哈哈哈哈哈啊哈哈哈哈啊哈,哈哈哈哈哈啊哈哈哈哈啊哈,哈哈哈哈哈啊哈哈哈哈啊哈，哈哈哈哈哈啊哈哈哈哈啊哈，哈哈哈哈哈啊哈哈哈哈啊哈</p>-->
                <!--</div>-->
                <!--<div class="msg-item clearfix">-->
                    <!--<span class="msg-owner">哈哈哈哈哈啊哈哈哈哈啊哈:</span>-->
                    <!--<p class="msg-content">哈哈哈哈哈啊哈哈哈哈啊哈,哈哈哈哈哈啊哈哈哈哈啊哈,哈哈哈哈哈啊哈哈哈哈啊哈，哈哈哈哈哈啊哈哈哈哈啊哈，哈哈哈哈哈啊哈哈哈哈啊哈</p>-->
                <!--</div>-->
                <!--<div class="msg-item clearfix">-->
                    <!--<span class="msg-owner">哈哈哈哈哈啊哈哈哈哈啊哈:</span>-->
                    <!--<p class="msg-content">哈哈哈哈哈啊哈哈哈哈啊哈,哈哈哈哈哈啊哈哈哈哈啊哈,哈哈哈哈哈啊哈哈哈哈啊哈，哈哈哈哈哈啊哈哈哈哈啊哈，哈哈哈哈哈啊哈哈哈哈啊哈</p>-->
                <!--</div>-->
                <!--<p class="text-center add-visiter">xxxx加入了房间</p>-->
                <!--<p class="text-center leave-visiter">xxxx离开了房间</p>-->
            </div>

        </div>
        <div class="send-msg">
            <form action="ddd" role="form" class="form-inline">
                <div class="form-group">
                    <input class="form-control message" type="text" name="massage" placeholder="您要说的话">
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-info" id="send-msg">发言</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/socket.io.js"></script>
<script type="text/javascript">
    window.onload=function () {
        var socket=io.connect("ws://127.0.0.1:8888");
        //定义全局变量
        var user="";
        var uid="";
        var roomId="";
        var utype="";
        var data="";

        //获取参数
        var parmas=getParmas();
        parmas["room"]?roomId=parmas["room"]:alert("你没有选择房间");
        parmas["userId"]?uid=parmas["userId"]:genUid();
        parmas["type"]?utype=parmas["type"]:0;
        parmas["userName"]?user=parmas["userName"]:username();

        userData={
            "user":user,
            "uid":uid,
            "roomId":roomId,
            "utype":utype
        }

        console.log(userData);
        // 判断用户类型，主播或者游客
        socket.emit('userIn',userData);
        //接收流媒体信息

        //接收屏幕信息
        socket.on("message",function (o) {
            console.log(o)
            updataMsg(o)
        })

        //监听加入
        socket.on("in",function (o) {
            userChange(o,"in")
        })

        //监听离开
        socket.on("out",function (o) {
            userChange(o,"out")
        })

        //发送消息
        $("#send-msg").click(function () {
            if($(".message").val()){
                var data={
                    "roomId":roomId,
                    "username":user,
                    "content":$(".message").val()
                };
                socket.emit("sendMsg",data);
                $(".message").val("");
            }
        })
        socket.on("sendMsg",function (o) {
            userChange(o,"out")
        });

        if(utype==1){
            var getUserMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);
            var URL = (window.URL || window.webkitURL || window.msURL || window.oURL);
            var PeerConnection = (window.PeerConnection || window.webkitPeerConnection00 || window.webkitRTCPeerConnection || window.mozRTCPeerConnection);

            getUserMedia.call(navigator, {
                video: true,
                audio: true
            }, function(localMediaStream) {
                var video = document.getElementById('video');
                if(URL){
                    video.src = URL.createObjectURL(localMediaStream);
                }else{
                    video.src=localMediaStream;
                }
                video.autoplay=true;
                socket.on("stream_created",localMediaStream);

            }, function(e) {
                console.log('浏览器不支持!', e);
            });
        }else {
            socket.on("mediaStream",function (o) {
                showMedia(o);
            });
        }

    };

    //公共方法
    function  genUid() {
        return new Date().getTime()+""+Math.floor(Math.random()*899+100);
    };
    
    function getParmas() {
        parmas=decodeURI(window.location.search.replace("?",""));
        room=parmas.split("&");
        result={};
        if(room){
            for(var i=0;i<room.length;i++){
                item=room[i].split("=");
                result[item[0]]=item[1];
            }
        }
        return result;
    };

    function username() {
        var username=prompt('请输入您的姓名');
        if (!username){
            alert('姓名必填');
            history.go(0);
        }
    }


    function userChange(o,action) {
        var username=o.user;
        var userNum=o.userNum;

        $(".userNum").text(userNum);

        if(action=="in"){
            var html='<p class="text-center leave-visiter">'+username+'加入了房间</p>';
        }
        if(action=="out"){
            var html='<p class="text-center leave-visiter">'+username+'离开了了房间</p>';
        }
        $(".msg-show-area").append(html);
    }

    function updataMsg(o) {
        var username=o.username;
        var content=o.content;

        var html='<div class="msg-item clearfix">'
                    +'<span class="msg-owner">'+username+':</span>'
                    +'<p class="msg-content">'+content+'</p>'
                +'</div>';
        $(".msg-show-area").append(html);
    }

    function showMedia(o) {
        var URL = (window.URL || window.webkitURL || window.msURL || window.oURL);
        if(URL){
            video.src = URL.createObjectURL(o);
        }else{
            video.src=o;
        }
        video.autoplay=true;
    }
</script>
</body>
</html>